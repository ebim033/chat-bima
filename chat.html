/**************** FIREBASE CONFIG ****************/
const firebaseConfig = {
  apiKey: "AIzaSyD7kN9qyueYOkc456U1QEWemSZryKzOeSk",
  authDomain: "chat-76acf.firebaseapp.com",
  databaseURL:
    "https://chat-76acf-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-76acf",
  messagingSenderId: "432041937284",
  appId: "1:432041937284:web:863da20e5d50db1519b5d1",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/**************** LOGIN / REGISTER ****************/
let isRegister = false;

function toggleForm() {
  isRegister = !isRegister;
  document.getElementById("formTitle").innerText = isRegister
    ? "Register"
    : "Login";
  document.querySelector("button").innerText = isRegister
    ? "Daftar"
    : "Masuk";
  document.getElementById("toggleText").innerText = isRegister
    ? "Sudah punya akun?"
    : "Belum punya akun?";
  document.getElementById("error").innerText = "";
}

function handleSubmit() {
  const username = document.getElementById("username")?.value.trim();
  const password = document.getElementById("password")?.value.trim();
  const error = document.getElementById("error");

  if (!username || !password) return;

  const userRef = db.ref("users/" + username);

  if (isRegister) {
    userRef.once("value", (snap) => {
      if (snap.exists()) {
        error.innerText = "Username sudah digunakan";
      } else {
        userRef.set({
          password,
          createdAt: Date.now(),
        });
        localStorage.setItem("chatUser", username);
        window.location.href = "chat.html";
      }
    });
  } else {
    userRef.once("value", (snap) => {
      if (!snap.exists()) {
        error.innerText = "User tidak ditemukan";
      } else if (snap.val().password !== password) {
        error.innerText = "Password salah";
      } else {
        localStorage.setItem("chatUser", username);
        window.location.href = "chat.html";
      }
    });
  }
}

/**************** CHAT ****************/
const currentUser = localStorage.getItem("chatUser");
const messagesRef = db.ref("privateChat");

if (currentUser && document.getElementById("messages")) {
  // üî• ADMIN FIX PAKSA
  const isAdmin = currentUser === "bima033";

  document.getElementById("userDisplay").innerText =
    "Login sebagai: " + currentUser + (isAdmin ? " üëë" : "");

  // tampil / sembunyi tombol admin (ANTI BUG)
  setTimeout(() => {
    const btn = document.querySelector(".danger");
    if (btn) btn.style.display = isAdmin ? "block" : "none";
  }, 100);

  window.sendMessage = function () {
    const input = document.getElementById("message");
    const text = input.value.trim();
    if (!text) return;

    messagesRef.push({
      user: currentUser,
      text,
      timestamp: Date.now(),
    });

    input.value = "";
  };

  messagesRef.limitToLast(100).on("child_added", (snap) => {
    const msg = snap.val();
    const messagesDiv = document.getElementById("messages");

    const wrapper = document.createElement("div");
    wrapper.className =
      "msg-wrapper " + (msg.user === currentUser ? "right" : "left");

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = `<strong>${msg.user}</strong><br>${msg.text}`;

    wrapper.appendChild(bubble);
    messagesDiv.appendChild(wrapper);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

/**************** ADMIN ACTION ****************/
function clearChat() {
  if (currentUser !== "bima033") {
    alert("‚ùå Bukan admin");
    return;
  }

  if (confirm("Yakin mau hapus semua chat?")) {
    messagesRef.remove();
    document.getElementById("messages").innerHTML = "";
  }
}

/**************** MENU ****************/
function toggleMenu() {
  document.getElementById("menuPanel").classList.toggle("hidden");
}

function logout() {
  localStorage.removeItem("chatUser");
  window.location.href = "index.html";
}

/**************** THEME ****************/
function setTheme(mode) {
  document.body.classList.remove("light", "dark");
  document.body.classList.add(mode);
  localStorage.setItem("chatTheme", mode);
}

document.body.classList.add(localStorage.getItem("chatTheme") || "light");
